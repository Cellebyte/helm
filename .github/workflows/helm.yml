name: CI

on:
  push:
    branches:
      - release
      - certmanager

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install Helm 3
      uses: Azure/setup-helm@v1
      with:
        version: v3.1.0
    - name: Get all submodule charts
      run: git submodule update --init --recursive
    - name: Move cert manager chart into charts dir
      run: mv external/cert-manager/deploy/charts/cert-manager charts/
    - name: add crds directory
      run: mkdir charts/cert-manager/crds/
    - name: enrich with crds
      uses: wei/curl@master
      with:
        args: -o charts/cert-manager/crds/00-crds.yaml  https://raw.githubusercontent.com/jetstack/cert-manager/release-0.11/deploy/manifests/00-crds.yaml
    - name: Lint Helm Charts
      run: helm lint charts/*
    - name: Add Bitnami repository
      run: helm repo add bitnami https://charts.bitnami.com/bitnami
    - name: Pull in all dependencies
      run: find 'charts/' -maxdepth 1 -mindepth 1 -exec helm dependency build {} \;
    - name: Package all Helm Charts
      run: find 'charts/' -maxdepth 1 -mindepth 1 -exec helm package {} \;
    - name: Checkout master
      run: git fetch --all && git checkout master && git status
    - name: Create new repoIndex
      run: helm repo index --url https://cellebyte.github.io/helm/ .
    - name: Add all files
      run: git add *.tgz index.yaml &&   git config --global user.email "actions@github.com" && git config --global user.name "CI GithubActions" && git commit -m "Updated Pages"
    - name: Push
      run: git push origin master
